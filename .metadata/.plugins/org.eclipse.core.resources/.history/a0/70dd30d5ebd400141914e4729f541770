import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Date;
import java.util.Scanner;

import javax.swing.JOptionPane;

import com.leapmotion.leap.Listener;



public class DataBase {

	private String dbURL = "jdbc:mysql://localhost:3306/robotarmlogin";
	private String username = "root";
	private String password = "";

	private int result;

	// reference to database connection
	private Connection connection;
	private PreparedStatement sqlInsertTime;
	private PreparedStatement sqlMaxUserid;

	private CreateAndShowGui showGUI;
	private LeapListener listener;
	
	public DataBase(CreateAndShowGui showGUI, LeapListener listener) {
		
		this.showGUI = showGUI;
		this.listener = listener;
		
	}
	
	//	public static void main(String[] args) throws Exception {
	//
	//		DataBase database = new DataBase();
	//		database.connect();
	//		database.readData();
	//
	//
	//	}

//	public void readDat1a() throws SQLException {
//		// sqlMaxUserid = connection.prepareStatement( "SELECT (StartTime,BreakIn,BreakOut,FinishTime) FROM staffhours WHERE NAME = Ian" );
//		//  ResultSet maxuserid = sqlMaxUserid.executeQuery();
//
//		//	   if(maxuserid.next())
//		//	   {
//		//		   String st =  maxuserid.getString(1);
//		//		   String bi =  maxuserid.getString(2);
//		//		   String bo =  maxuserid.getString(3);
//		//		String ft = null;
//		//			String name = "Alan";
//		//		   
//		//		   
//		//		   
//		//		   System.out.print("Data Inserted" + st);
//		//		   System.out.print("\nData Inserted" + bi);
//		//		   System.out.print("\nData Inserted" + bo);
//		//		   System.out.print("Data Inserted" + ft);
//		//		String userName = "Ian";
//		//
//		String query = "SELECT Password,LoginTime,LogoutTime,notes FROM login " +
//				"WHERE Name = '"+name+"'";
//		Statement stmt = connection.createStatement();
//		ResultSet rs = stmt.executeQuery(query);
//
//		if(rs.next())
//		{
//			String st =  rs.getString("Password");
//			String bi =  rs.getString("LoginTime");
//			String bo =  rs.getString("LogoutTime");
//			ft =  rs.getString("Notes");
//
//
//
//
//
//
//			System.out.print("st" + st);
//			System.out.print("\nbi\t" + bi);
//			if(ft!=null)
//			{
//				System.out.print("SHE IS EMPTY");
//			}
//			System.out.print("\nbo\t" + bo);
//			System.out.print("\nft\t" + ft);
//
//		}
//		if(ft==null)
//		{
//			System.out.print("SHE IS EMPTY");
//		}
//
//		connection.close();
//
//		//		int i = 0;
//		//
//		//		while(i < 5) {
//		/*
//			try{	 
//
//				String user = "" ;
//				String password = "";
//				String time = "";
//				String notes = "";
//
//				Scanner sc = new Scanner(System.in);
//				System.out.println("Enter Your user name: ");
//				user = sc.next();
//
//				System.out.println("Enter Your password: ");
//				password = sc.next();
//
//				System.out.println("Notes?: ");
//				notes = sc.next();
//
//				Date d = new Date(System.currentTimeMillis());
//				System.out.print(d);
//
//				time = d.toString();
//
//				sqlInsertTime = connection.prepareStatement(
//						"UPDATE login SET LoginTime = '"+time+"', Password = '"+password+"', Notes = '"+notes+"' " + 
//						"WHERE Name = '"+user+"' ");
//
//
//				result = sqlInsertTime.executeUpdate();
//
//				if ( result == 0 ) {
//					connection.rollback(); // rollback update
//
//				}      
//
//				connection.commit();        
//				//i++;
//			}
//			catch ( SQLException sqlException ) {
//				// rollback transaction
//				System.out.println("SQL exception = " + sqlException);
//			}
//
//			System.out.print("Data Inserted");
//
//			sqlInsertTime.close();
//			// sqlMaxUserid.close();
//			//connection.close();
//
//
////		}
//
//		connection.close();
//		 */
//	}

	public void currentUserReadData() throws Exception{



	}

	public void updateData() throws Exception{


	}

	public boolean login() throws Exception{

		String username = showGUI.jTextFieldUserName.getText();
		char[] passwordtemp = showGUI.jPasswordFieldPassword.getPassword();
		
		String password = new String(passwordtemp);
		
		
		
		if(username.isEmpty() || password.isEmpty()) {
			
			if(listener.isSystemStatsFlag() == true) {
				
				showGUI.printStatus("No Data In either Field, Try Again");
				
			}
			
		}
		else {

			//get query and compare password & name
			String query = "SELECT Password,LoginTime,LogoutTime,notes FROM login " +
					"WHERE Name = '"+username+"'";
			Statement stmt = connection.createStatement();
			ResultSet rs = stmt.executeQuery(query);
	
			if(rs.next()) {
				
				System.out.println("In here");
				//String dbUsername = rs.getString("Name");
				String dbPassword = rs.getString("Password");
				
				System.out.println(password + dbPassword);
				
				if(password.equals(dbPassword)) {
					
					if(listener.isSystemStatsFlag() == true) {
						
						showGUI.printStatus("Current User: " + username);
						
					}
					JOptionPane.showMessageDialog(null, "Hello " + username);
					return true;
					
				}
				else {
					
					if(listener.isSystemStatsFlag() == true) {
						
						showGUI.printStatus("Invalid Password");
						
					}
					return false;
				}
			}
			else {
						
				if(listener.isSystemStatsFlag() == true) {
					
					showGUI.printStatus("Invalid Username");
					
				}
				return false;
			}
		}
		return false;
	}

	public void logout() {


	}

	public void connect() throws Exception {
		
			Class.forName("com.mysql.jdbc.Driver").newInstance();
			connection = DriverManager.getConnection(dbURL, username, password);
			System.out.println("Connected to database....\n");
			connection.setAutoCommit( false );
	
	}

} 